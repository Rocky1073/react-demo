<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <title>人民调解-纠纷申请</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/3.19.0/antd.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/antd/3.19.0/antd.css"
    />
  </head>
  <body>
    <div id="root" style="width: 50%; margin: 0 auto;"></div>
    <script type="text/babel">
      moment.locale("zh-cn");
      const locale = {
        lang: {
          placeholder: "请选择日期",
          rangePlaceholder: ["开始日期", "结束日期"],
          today: "今天",
          now: "此刻",
          backToToday: "返回今天",
          ok: "确定",
          timeSelect: "选择时间",
          dateSelect: "选择日期",
          weekSelect: "选择周",
          clear: "清除",
          month: "月",
          year: "年",
          previousMonth: "上个月 (翻页上键)",
          nextMonth: "下个月 (翻页下键)",
          monthSelect: "选择月份",
          yearSelect: "选择年份",
          decadeSelect: "选择年代",
          yearFormat: "YYYY年",
          dayFormat: "D日",
          dateFormat: "YYYY年M月D日",
          dateTimeFormat: "YYYY年M月D日 HH时mm分ss秒",
          previousYear: "上一年 (Control键加左方向键)",
          nextYear: "下一年 (Control键加右方向键)",
          previousDecade: "上一年代",
          nextDecade: "下一年代",
          previousCentury: "上一世纪",
          nextCentury: "下一世纪"
        },
        timePickerLocale: {
          placeholder: "请选择时间"
        },
        dateFormat: "YYYY-MM-DD",
        dateTimeFormat: "YYYY-MM-DD HH:mm:ss",
        weekFormat: "YYYY-wo",
        monthFormat: "YYYY-MM"
      };

      const {
        Row,
        Col,
        Form,
        Button,
        Card,
        Input,
        Select,
        DatePicker,
        Table,
        Popconfirm,
        LocaleProvider
      } = antd;

      const { Item: FormItem } = Form;
      const { Option } = Select;
      const { TextArea } = Input;

      // 当事人基本信息
      const Types = [
        { value: "01", label: "个人" },
        { value: "02", label: "单位" }
      ];
      const CardTypes = [
        { value: "111", label: "居民身份证" },
        { value: "112", label: "临时居民身份证" },
        { value: "113", label: "户口簿" },
        { value: "114", label: "中国人民解放军军官证" },
        { value: "115", label: "中国人民武装警察部队警官证" },
        { value: "233", label: "军人通行证" },
        { value: "411", label: "外交护照" },
        { value: "412", label: "公务护照" },
        { value: "413", label: "因公普通护照" },
        { value: "414", label: "普通护照" }
      ];
      const Sex = [{ value: "01", label: "男" }, { value: "02", label: "女" }];
      // 纠纷基本信息
      const DisputeIsDeath = [
        { value: "01", label: "否" },
        { value: "02", label: "是" }
      ];
      const DisputeDeathTypes = [
        { value: "01", label: "医患纠纷死亡" },
        { value: "02", label: "学生意外死亡" },
        { value: "03", label: "安全生产事故致死" },
        { value: "04", label: "交通事故致人死亡" },
        { value: "05", label: "自杀死亡" },
        { value: "06", label: "溺水死亡" },
        { value: "99", label: "其他死亡" }
      ];

      class App extends React.PureComponent {
        constructor(props) {
          super(props);
          this.state = {
            submitting: false,
            disputeIsDeath: DisputeIsDeath[0].value,
            city: [],
            district: [],
            committee: []
          };
        }

        componentDidMount() {
          // 这里做初始化查询，赋值市、区、委员会
          this.setState({
            city: [
              { value: "01", label: "杭州" },
              { value: "02", label: "宁波" }
            ],
            district: [
              { value: "0101", label: "下城区" },
              { value: "0102", label: "上城区" }
            ],
            committee: [
              { value: "010101", label: "下城区人民调解委员会" },
              { value: "020101", label: "杭州市下城区交通事故人民调解委员会" }
            ]
          });
        }

        onChangeDisputeIsDeath = value => {
          this.setState({ disputeIsDeath: value });
        };

        handleSubmit = e => {
          e.preventDefault();
          this.setState({ submitting: true }, () => {
            const { form } = this.props;
            form.validateFieldsAndScroll((err, values) => {
              if (!err) {
                const { another, disputeTime } = values;
                const fields = {
                  ...values,
                  another: another.map(item => ({
                    ...item,
                    key: undefined
                  })),
                  disputeTime: disputeTime
                    ? disputeTime.format("YYYY-MM-DD")
                    : undefined
                };
                // another 对方基本信息
                // another 里 name姓名 sex性别 number联系电话 address联系地址
                // disputeCommittee 申请调委会
                // disputeDescription 纠纷描述
                // disputeIsDeath 是否有死亡
                // disputeLocation 纠纷地点
                // disputeTime 纠纷时间
                // litigantAddress 当事人联系地址
                // litigantCardType 当事人证件类型
                // litigantMobile 当事人联系电话
                // litigantName 当事人姓名
                // litigantNumber 当事人证件号码
                // litigantSex 当事人性别
                // litigantType 当事人证件类型

                // 这里请求接口fields是请求接口参数
              }
              this.setState({ submitting: false });
            });
          });
        };

        validator = (rule, value, callback) => {
          if (value.length) {
            for (const item of value) {
              if (!item.name || !item.sex) {
                callback("姓名与性别为必填");
                return;
              }
              if (item.number && !/^1\d{10}$/.test(item.number)) {
                callback("请输入正确的联系方式");
                return;
              }
            }
            callback();
          } else {
            callback("至少有一条数据");
          }
        };

        onSearchCity = val => {
          // 这里请求数据，val为值

          // 这里赋值区域和委员会数据
          this.setState({
            district: [
              { value: "0201", label: "拱墅区" },
              { value: "0202", label: "临安区" }
            ],
            committee: [
              { value: "030101", label: "淳安县医调会" },
              { value: "040101", label: "富阳区人民调解委员会" },
              { value: "050101", label: "富阳区医疗纠纷人民调解委员会" }
            ]
          });
        };

        onSearchDistrict = val => {
          // 这里请求数据，val为值

          // 这里赋值委员会数据
          this.setState({
            committee: [
              { value: "030101", label: "淳安县医调会" },
              { value: "040101", label: "富阳区人民调解委员会" },
              { value: "050101", label: "富阳区医疗纠纷人民调解委员会" }
            ]
          });
        };

        render() {
          const { getFieldDecorator } = this.props.form;
          const {
            submitting,
            disputeIsDeath,
            city,
            district,
            committee
          } = this.state;

          return (
            <React.Fragment>
              <Form layout="vertical" onSubmit={this.handleSubmit}>
                <Card
                  bodyStyle={{ paddingBottom: 0 }}
                  title="当事人基本信息"
                  bordered={false}
                >
                  <Row gutter={16}>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="证件类型">
                        {getFieldDecorator("litigantType", {
                          initialValue: Types[0].value,
                          rules: [{ required: true, message: "证件类型必选" }]
                        })(
                          <Select placeholder="请选择证件类型">
                            {Types.map(({ value, label }) => (
                              <Option key={value}>{label}</Option>
                            ))}
                          </Select>
                        )}
                      </FormItem>
                    </Col>
                    <Col lg={12} md={24} sm={24}>
                      <FormItem label="证件类型">
                        {getFieldDecorator("litigantCardType", {
                          initialValue: CardTypes[0].value,
                          rules: [{ required: true, message: "证件类型必选" }]
                        })(
                          <Select placeholder="请选择证件类型">
                            {CardTypes.map(({ value, label }) => (
                              <Option key={value}>{label}</Option>
                            ))}
                          </Select>
                        )}
                      </FormItem>
                    </Col>
                  </Row>
                  <Row gutter={16}>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="证件号码">
                        {getFieldDecorator("litigantNumber", {
                          rules: [
                            {
                              pattern: /^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/,
                              message: "请输入正确的证件号码"
                            },
                            { required: true, message: "证件号码必填" }
                          ]
                        })(<Input placeholder="请输入证件号码" />)}
                      </FormItem>
                    </Col>
                    <Col lg={12} md={24} sm={24}>
                      <FormItem label="姓名">
                        {getFieldDecorator("litigantName", {
                          rules: [{ required: true, message: "姓名必填" }]
                        })(<Input placeholder="请输入姓名" />)}
                      </FormItem>
                    </Col>
                  </Row>
                  <Row gutter={16}>
                    <Col lg={12} md={24} sm={24}>
                      <FormItem label="性别">
                        {getFieldDecorator("litigantSex", {
                          rules: [{ required: true, message: "性别必选" }]
                        })(
                          <Select placeholder="请选择性别">
                            {Sex.map(({ value, label }) => (
                              <Option key={value}>{label}</Option>
                            ))}
                          </Select>
                        )}
                      </FormItem>
                    </Col>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="联系电话">
                        {getFieldDecorator("litigantMobile", {
                          rules: [
                            {
                              pattern: /^1\d{10}$/,
                              message: "请输入正确的格式"
                            },
                            { required: true, message: "联系电话必填" }
                          ]
                        })(<Input placeholder="请输入联系电话" />)}
                      </FormItem>
                    </Col>
                  </Row>
                  <Row gutter={16}>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="联系地址">
                        {getFieldDecorator("litigantAddress", {
                          rules: [{ required: true, message: "联系地址必填" }]
                        })(<Input placeholder="请输入联系地址" />)}
                      </FormItem>
                    </Col>
                  </Row>
                </Card>
                <Card
                  bodyStyle={{ paddingBottom: 0 }}
                  title="对方基本信息"
                  bordered={false}
                >
                  <FormItem>
                    {getFieldDecorator("another", {
                      initialValue: [],
                      rules: [{ validator: this.validator }]
                    })(<TableForm />)}
                  </FormItem>
                </Card>
                <Card
                  bodyStyle={{ paddingBottom: 0 }}
                  title="纠纷基本信息"
                  bordered={false}
                >
                  <Row gutter={16}>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="是否有死亡">
                        {getFieldDecorator("disputeIsDeath", {
                          initialValue: DisputeIsDeath[0].value,
                          rules: [{ required: true, message: "此项必填" }]
                        })(
                          <Select
                            placeholder="请选择"
                            onChange={this.onChangeDisputeIsDeath}
                          >
                            {DisputeIsDeath.map(({ value, label }) => (
                              <Option key={value}>{label}</Option>
                            ))}
                          </Select>
                        )}
                      </FormItem>
                    </Col>
                    {disputeIsDeath === "02" && (
                      <Col lg={12} md={24} sm={24}>
                        <FormItem label="死亡类型">
                          {getFieldDecorator("disputeDeathType")(
                            <Select placeholder="请选择死亡类型">
                              {DisputeDeathTypes.map(({ value, label }) => (
                                <Option key={value}>{label}</Option>
                              ))}
                            </Select>
                          )}
                        </FormItem>
                      </Col>
                    )}
                  </Row>
                  <Row gutter={16}>
                    <Col lg={12} md={12} sm={24}>
                      <FormItem label="纠纷时间">
                        {getFieldDecorator("disputeTime")(
                          <DatePicker
                            locale={locale}
                            placeholder="请选择时间"
                            style={{ width: "100%" }}
                          />
                        )}
                      </FormItem>
                    </Col>
                    <Col lg={12} md={24} sm={24}>
                      <FormItem label="纠纷地点">
                        {getFieldDecorator("disputeLocation")(
                          <Input placeholder="请输入纠纷地点" />
                        )}
                      </FormItem>
                    </Col>
                  </Row>
                  <Row gutter={16}>
                    <Col span={24}>
                      <FormItem label="纠纷描述">
                        {getFieldDecorator("disputeDescription", {
                          rules: [{ max: 300, message: "长度不能超过300字" }]
                        })(<TextArea rows={4} placeholder="请输入纠纷描述" />)}
                      </FormItem>
                    </Col>
                  </Row>
                  <Row gutter={16}>
                    <Col lg={8} sm={24}>
                      <FormItem label="市">
                        <Select
                          placeholder="请选择市"
                          onSearch={this.onSearchCity}
                        >
                          {city.map(({ value, label }) => (
                            <Option key={value}>{label}</Option>
                          ))}
                        </Select>
                      </FormItem>
                    </Col>
                    <Col lg={8} sm={24}>
                      <FormItem label="区">
                        <Select
                          placeholder="请选择区"
                          onSearch={this.onSearchDistrict}
                        >
                          {district.map(({ value, label }) => (
                            <Option key={value}>{label}</Option>
                          ))}
                        </Select>
                      </FormItem>
                    </Col>
                    <Col lg={8} sm={24}>
                      <FormItem label="申请调委会">
                        {getFieldDecorator("disputeCommittee", {
                          rules: [{ required: true, message: "申请调委会必选" }]
                        })(
                          <Select placeholder="请选择申请调委会">
                            {committee.map(({ value, label }) => (
                              <Option key={value}>{label}</Option>
                            ))}
                          </Select>
                        )}
                      </FormItem>
                    </Col>
                  </Row>
                </Card>
                <div style={{ textAlign: "center" }}>
                  <Button
                    size="large"
                    type="primary"
                    htmlType="submit"
                    loading={submitting}
                  >
                    提交申请
                  </Button>
                </div>
              </Form>
            </React.Fragment>
          );
        }
      }

      class TableForm extends React.PureComponent {
        index = 0;

        newMember = () => {
          const { value } = this.props;
          const newData = value.map(item => ({ ...item }));
          newData.push({ key: `NEW_TEMP_ID_${this.index}` });
          this.index += 1;
          this.props.onChange(newData);
        };

        remove(key) {
          const { value } = this.props;
          const newData = value.filter(item => item.key !== key);
          this.props.onChange(newData);
        }

        handleFieldChange(e, fieldName, key) {
          const { value } = this.props;
          const newData = value.map(item => ({ ...item }));
          const target = newData.filter(item => item.key === key)[0];
          if (target) {
            target[fieldName] = e;
            this.props.onChange(newData);
          }
        }

        render() {
          const { value } = this.props;

          const columns = [
            {
              title: "姓名",
              dataIndex: "name",
              key: "name",
              width: "20%",
              render: (text, record) => (
                <Input
                  value={text}
                  onChange={e =>
                    this.handleFieldChange(e.target.value, "name", record.key)
                  }
                  placeholder="姓名"
                />
              )
            },
            {
              title: "性别",
              dataIndex: "sex",
              key: "sex",
              width: "20%",
              render: (text, record) => (
                <Select
                  value={text}
                  onChange={e => this.handleFieldChange(e, "sex", record.key)}
                  placeholder="性别"
                >
                  {Sex.map(({ value, label }) => (
                    <Option key={value}>{label}</Option>
                  ))}
                </Select>
              )
            },
            {
              title: "联系电话",
              dataIndex: "number",
              key: "number",
              width: "25%",
              render: (text, record) => (
                <Input
                  value={text}
                  onChange={e =>
                    this.handleFieldChange(e.target.value, "number", record.key)
                  }
                  placeholder="联系电话"
                />
              )
            },
            {
              title: "联系地址",
              dataIndex: "address",
              key: "address",
              width: "25%",
              render: (text, record) => (
                <Input
                  value={text}
                  onChange={e =>
                    this.handleFieldChange(
                      e.target.value,
                      "address",
                      record.key
                    )
                  }
                  placeholder="联系地址"
                />
              )
            },
            {
              title: "操作",
              key: "action",
              width: "10%",
              render: (text, record) => (
                <Popconfirm
                  title="是否要删除此行？"
                  okText="确认"
                  cancelText="取消"
                  onConfirm={() => this.remove(record.key)}
                >
                  <a>删除</a>
                </Popconfirm>
              )
            }
          ];

          return (
            <React.Fragment>
              <Table columns={columns} dataSource={value} pagination={false} />
              <Button
                style={{ width: "100%", marginTop: 16, marginBottom: 8 }}
                type="dashed"
                onClick={this.newMember}
                icon="plus"
              >
                新增成员
              </Button>
            </React.Fragment>
          );
        }
      }

      const WrappedNormalLoginForm = Form.create()(App);

      ReactDOM.render(
        <WrappedNormalLoginForm />,
        document.getElementById("root")
      );
    </script>
  </body>
</html>

<!DOCTYPE html>
